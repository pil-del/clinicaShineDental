<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes</title>
    <link rel="shortcut icon" type="image/png" href="/images/shine.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        /* Estilo para los botones de paginación */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #007bff;
            background-color: transparent;
            border: none;
            padding: 0;
            margin: 0 5px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Estilo para el botón de la página actual */
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
        }

        /* Estilo para el botón de paginación al pasar el mouse por encima */
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: white;
            background-color: #0056b3;
            border: none;
            border-radius: 4px;
        }

        /* Oculta el cuadro de búsqueda predeterminado de DataTables */
        .dataTables_filter {
          display: none;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        #page-content-wrapper {
            flex: 1;
        }

        footer {
            position: relative;
            bottom: 0;
            width: 100%;
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 10px 0;
        }

    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="bg-dark border-right" id="sidebar-wrapper">
            <div class="sidebar-heading text-white">
                <div>
                    <img src="/images/shine.png" alt="Logo" class="img-fluid mb-2" style="max-width: 50px;">
                    SHINE DENTAL
                </div>
            </div>
            <div class="list-group list-group-flush">
                <a href="#clientes-pacientes-submenu" class="list-group-item list-group-item-action bg-dark text-white" data-toggle="collapse">
                    <i class="fas fa-user"></i> Pacientes
                </a>
                <div id="clientes-pacientes-submenu" class="collapse">
                    <a href="/admin/pacientes" class="list-group-item list-group-item-action bg-dark text-white pl-4 active">Pacientes</a>
                    <a href="/admin/citas" class="list-group-item list-group-item-action bg-dark text-white pl-4">Citas</a>
                    <a href="/admin/historial" class="list-group-item list-group-item-action bg-dark text-white pl-4">Historial Tratamiento</a>
                    <a href="/admin/pago" class="list-group-item list-group-item-action bg-dark text-white pl-4">Control de Pago</a>
                    <a href="/admin/archivados" class="list-group-item list-group-item-action bg-dark text-white pl-4">Pacientes Archivados</a>
                </div>
            
                <a href="#doctores-submenu" class="list-group-item list-group-item-action bg-dark text-white" data-toggle="collapse">
                    <i class="fas fa-user-md"></i> Doctores
                </a>
                <div id="doctores-submenu" class="collapse">
                    <a href="/admin/doctores" class="list-group-item list-group-item-action bg-dark text-white pl-4">Doctores</a>
                    <a href="/admin/usuarios" class="list-group-item list-group-item-action bg-dark text-white pl-4">Usuarios Activos</a>
                    <a href="/admin/usuariosinactivos" class="list-group-item list-group-item-action bg-dark text-white pl-4">Usuarios Inactivos</a>
                </div>
            
                <a href="#inventario-submenu" class="list-group-item list-group-item-action bg-dark text-white" data-toggle="collapse">
                    <i class="fas fa-box"></i> Inventario
                </a>
                <div id="inventario-submenu" class="collapse">
                    <a href="/admin/inventario" class="list-group-item list-group-item-action bg-dark text-white pl-4">Inventario</a>
                    <a href="/admin/compra" class="list-group-item list-group-item-action bg-dark text-white pl-4">Compra</a>
                </div>
            
                <a href="#reportes-submenu" class="list-group-item list-group-item-action bg-dark text-white" data-toggle="collapse">
                    <i class="fas fa-chart-bar"></i> Reportes
                </a>
                
                <a href="/admin/dashboard" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="fas fa-arrow-circle-left"></i> Regresar al Panel
                </a>
            
                <a href="/admin/login" class="list-group-item list-group-item-action bg-danger text-white">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>            
            <!-- Botón de flecha -->
            <button class="btn btn-dark toggle-btn" id="menu-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <h1 class="mt-4">Pacientes</h1>
                <div class="text-left mb-3">
                    <a href="/admin/dashboard" class="btn btn-secondary">&larr; Regresar al Panel de Control</a>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addpacienteModal">Agregar Paciente</button>
                </div>

                <!-- Barra de búsqueda -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Buscar paciente..." id="searchPaciente">
                </div>

        <!-- Tabla de pacientes -->
        <div class="card">
            <div class="card-header">Listado de Pacientes</div>
            <div class="card-body">
                <table id="pacienteTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>DPI</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Edad</th>
                            <th>Tipo de Paciente</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% pacientes.forEach(function(paciente) { %>
                            <tr>
                                <td><%= paciente.dpi %></td>
                                <td><%= paciente.nombre +" "+ paciente.apellido%></td>
                                <td><%= paciente.telefono %></td>
                                <td><%= paciente.email %></td>
                                <td><%= paciente.edad %></td>
                                <td>
                                    <% if (paciente.tipoPaciente_idtipoPaciente == 1) { %>
                                    Nuevo Paciente
                                    <% } else if (paciente.tipoPaciente_idtipoPaciente == 2) { %>
                                    Paciente Recurrente
                                    <% } else{ %>
                                        Paciente de Emergencia
                                    <% } %> 
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editarPaciente('<%= paciente.idPaciente %>', '<%= paciente.nombre %>', '<%= paciente.apellido %>', '<%= paciente.telefono %>', '<%= paciente.email %>', '<%= paciente.edad %>', '<%= paciente.tipoPaciente_idtipoPaciente %>', '<%= paciente.direccion %>', '<%= paciente.nit %>', '<%= paciente.dpi %>', '<%= paciente.genero_idGenero %>')">Editar</button>
                                    <% 
                                    let generoStr;
                                    if (paciente.genero_idGenero == 1) {
                                      generoStr = 'Masculino';
                                    } else if (paciente.genero_idGenero == 2) {
                                      generoStr = 'Femenino';
                                    } else if (paciente.genero_idGenero == 3) {
                                      generoStr = 'Otro';
                                    } else {
                                      generoStr = 'Desconocido';
                                    }
                                  %>
                                  
                                  <button class="btn btn-primary btn-sm" onclick="verInformacion('<%= paciente.idPaciente %>', '<%= paciente.nombre %>', '<%= paciente.apellido %>', '<%= paciente.telefono %>', '<%= paciente.email %>', '<%= paciente.edad %>', '<%= paciente.tipoPaciente_idtipoPaciente %>', '<%= generoStr %>', '<%= paciente.fechaNacimiento %>', '<%= paciente.direccion %>', '<%= paciente.nit %>', '<%= paciente.dpi %>', '<%= paciente.historialClinico %>', '<%= paciente.fichaMedica %>')">Ver Información</button>
                                  <button class="btn btn-warning btn-sm" onclick="archivarPaciente('<%= paciente.idPaciente %>')">Archivar</button>
                                    <button class="btn btn-warning btn-sm" onclick="fichaMedica('<%= paciente.idPaciente %>')">Ficha Médica</button>
                                </td>                                
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

    <!-- Modal para ver información del paciente -->
    <div class="modal fade" id="infopacienteModal" tabindex="-1" aria-labelledby="infopacienteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infopacienteModalLabel">Información del paciente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <dl class="row">

                        <dt class="col-sm-3">Nombre:</dt>
                        <dd class="col-sm-9" id="infopacienteName"></dd>

                        <dt class="col-sm-3">Apellido:</dt>
                        <dd class="col-sm-9" id="infopacienteLastName"></dd>

                        <dt class="col-sm-3">DPI:</dt>
                        <dd class="col-sm-9" id="infopacienteDpi"></dd>

                        <dt class="col-sm-3">Teléfono:</dt>
                        <dd class="col-sm-9" id="infopacientePhone"></dd>

                        <dt class="col-sm-3">Email:</dt>
                        <dd class="col-sm-9" id="infopacienteEmail"></dd>

                        <dt class="col-sm-3">Edad:</dt>
                        <dd class="col-sm-9" id="infopacienteEdad"></dd>

                        <dt class="col-sm-3">Género:</dt>
                        <dd class="col-sm-9" id="infopacienteGenero"></dd>

                        <dt class="col-sm-3">Fecha de Nacimiento:</dt>
                        <dd class="col-sm-9" id="infopacienteFechaNacimiento"></dd>

                        <dt class="col-sm-3">Dirección:</dt>
                        <dd class="col-sm-9" id="infopacienteDireccion"></dd>

                        <dt class="col-sm-3">NIT:</dt>
                        <dd class="col-sm-9" id="infopacienteNit"></dd>

                        <dt class="col-sm-3">Tipo de Paciente:</dt>
                        <dd class="col-sm-9" id="infopacienteTipoPaciente"></dd>

                        <dt class="col-sm-3">Historial Clínico:</dt>
                        <dd class="col-sm-9" id="infopacienteHistorialClinico"></dd>

                        <dt class="col-sm-3">Ficha Médica:</dt>
                        <dd class="col-sm-9" id="infopacienteFichaMedica"></dd>

                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Modal para agregar paciente -->
<div class="modal fade" id="addpacienteModal" tabindex="-1" aria-labelledby="addpacienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addpacienteModalLabel">Agregar paciente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addPacienteForm" action="/admin/pacientes" method="POST">
                    <!-- Campos del formulario -->
                    <div class="form-group">
                        <label for="nombre" class="form-label">Nombre/s</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="apellido" class="form-label">Apellido/s</label>
                        <input type="text" class="form-control" id="apellido" name="apellido" required>
                    </div>
                    <div class="form-group">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono" name="telefono" required>
                    </div>
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="edad" class="form-label">Edad</label>
                        <input type="number" class="form-control" id="edad" name="edad" readonly>
                    </div>
                    <div class="form-group">
                        <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label for="direccion" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                    </div>
                    <div class="form-group">
                        <label for="nit" class="form-label">NIT</label>
                        <input type="text" class="form-control" id="nit" name="nit">
                    </div>
                    <div class="form-group">
                        <label for="dpi" class="form-label">DPI</label>
                        <input type="text" class="form-control" id="dpi" name="dpi" required>
                    </div>
                    <div class="form-group">
                        <label for="genero_idGenero" class="form-label">Género</label>
                        <select id="genero_idGenero" class="form-control" name="genero_idGenero" required>
                            <option value="">Seleccionar Género</option>
                            <option value="1">Masculino</option>
                            <option value="2">Femenino</option>
                            <option value="3">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoPaciente_idtipoPaciente" class="form-label">Tipo de Paciente</label>
                        <select id="tipoPaciente_idtipoPaciente" class="form-control" name="tipoPaciente_idtipoPaciente" required>
                            <option value="">Seleccionar...</option>
                            <option value="1">Nuevo Paciente</option>
                            <option value="2">Paciente Recurrente</option>
                            <option value="3">Paciente de Emergencia</option>
                        </select>
                    </div>

                    <!-- Información del contacto de emergencia -->
                    <h5>Información de Contacto de Emergencia</h5>
                    <div class="form-group">
                        <label for="nombreEmergencia" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombreEmergencia" name="nombreEmergencia" required>
                    </div>
                    <div class="form-group">
                        <label for="numeroEmergencia" class="form-label">Número de Teléfono</label>
                        <input type="text" class="form-control" id="numeroEmergencia" name="numeroEmergencia" required>
                    </div>
                    <div class="form-group">
                        <label for="parentescoEmergencia" class="form-label">Vínculo Familiar</label>
                        <input type="text" class="form-control" id="parentescoEmergencia" name="parentescoEmergencia" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Guardar paciente</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Evento para calcular la edad automáticamente al seleccionar la fecha de nacimiento
    document.getElementById('fechaNacimiento').addEventListener('change', function() {
        const birthDate = new Date(this.value);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDifference = today.getMonth() - birthDate.getMonth();

        if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }

        document.getElementById('edad').value = age;
    });
</script>


        <!-- Modal para agregar ficha medica -->
        <div class="modal fade" id="addfichamedica" tabindex="-1" aria-labelledby="addfichamedicaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addfichamedica">Agregar paciente</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form action="/guardar-ficha-medica" method="POST">
                            <!-- Preguntas con respuestas Sí o No -->
                            <div class="form-group">
                                <label>1. ¿Padece de alguna enfermedad del corazón?</label>
                                <select name="enfermedad_corazon" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>2. ¿Padece de la presión alta o baja?</label>
                                <select name="presion_alta_baja" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>3. ¿Es diabético?</label>
                                <select name="diabetico" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>4. ¿Ha tenido operaciones en los últimos 6 meses?</label>
                                <select name="operaciones_recientes" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>5. ¿Ha tenido hepatitis?</label>
                                <select name="hepatitis" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>6. ¿Padece del hígado o riñones?</label>
                                <select name="enfermedad_higado_rinones" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>7. ¿Sufre de convulsiones o desmayos?</label>
                                <select name="convulsiones_desmayos" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>8. ¿Ha tenido o tiene alguna enfermedad de transmisión sexual?</label>
                                <select name="enfermedad_transmision_sexual" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>9. ¿Padece de alergias?</label>
                                <select name="alergias" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>10. ¿Padece de alguna enfermedad respiratoria?</label>
                                <select name="enfermedad_respiratoria" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>11. ¿Se encuentra embarazada?</label>
                                <select name="embarazada" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>12. ¿Padece de artritis?</label>
                                <select name="artritis" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>13. ¿Padece de fiebre reumática?</label>
                                <select name="fiebre_reumatica" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>14. ¿Sufre de hemorragias espontáneas?</label>
                                <select name="hemorragias_espontaneas" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>15. ¿Padece de alguna enfermedad no mencionada anteriormente?</label>
                                <select name="enfermedad_no_mencionada" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>16. ¿Es alérgico a algún material odontológico (látex, anestesia, eugenol)?</label>
                                <select name="alergia_material_odontologico" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>17. ¿Le sangran las encías?</label>
                                <select name="sangrado_encias" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>18. ¿Padece de halitosis (mal aliento)?</label>
                                <select name="halitosis" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>19. ¿Es alérgico a algún medicamento?</label>
                                <select name="alergia_medicamento" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>20. ¿Tiene "fuegos" (aftas) dentro o fuera de la boca?</label>
                                <select name="aftas" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>21. ¿Tiene dolor dental?</label>
                                <select name="dolor_dental" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <div class="form-group">
                                <label>22. ¿Tiene sensibilidad dental?</label>
                                <select name="sensibilidad" class="form-control">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                
                            <!-- Preguntas abiertas -->
                            <div class="form-group">
                                <label>23. ¿Cuándo fue su última visita al dentista?</label>
                                <input type="text" name="ultima_visita_dentista" class="form-control">
                            </div>
                
                            <div class="form-group">
                                <label>24. ¿Qué tratamiento dental se realizó?</label>
                                <input type="text" name="tratamiento_realizado" class="form-control">
                            </div>
                
                            <!-- Botón para enviar el formulario -->
                            <button type="submit" class="btn btn-primary">Guardar Ficha Médica</button>
                        </form>                                                                                      
                    </div>
                </div>
            </div>
        </div>

  <!-- Modal para editar paciente -->
<div class="modal fade" id="editpacienteModal" tabindex="-1" aria-labelledby="editpacienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editpacienteModalLabel">Editar paciente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editPacienteForm" action="/updatepaciente" method="POST">
                    <input id="editpacienteId" name="idpaciente" type="hidden">
                    <div class="form-group">
                        <label for="editNombre" class="form-label">Nombre/s</label>
                        <input type="text" class="form-control" id="editNombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="editApellido" class="form-label">Apellido/s</label>
                        <input type="text" class="form-control" id="editApellido" name="apellido" required>
                    </div>
                    <div class="form-group">
                        <label for="editTelefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="editTelefono" name="telefono" required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="editEdad" class="form-label">Edad</label>
                        <input type="number" class="form-control" id="editEdad" name="edad" readonly>
                    </div>

                    <div class="form-group">
                        <label for="editDireccion" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="editDireccion" name="direccion" required>
                    </div>
                    <div class="form-group">
                        <label for="editNit" class="form-label">NIT</label>
                        <input type="text" class="form-control" id="editNit" name="nit" required>
                    </div>
                    <div class="form-group">
                        <label for="editDpi" class="form-label">DPI</label>
                        <input type="text" class="form-control" id="editDpi" name="dpi" required>
                    </div>
                    <div class="form-group">
                        <label for="editGenero" class="form-label">Género</label>
                        <select id="editGenero" class="form-control" name="genero_idGenero" required>
                            <option value="1">Masculino</option>
                            <option value="2">Femenino</option>
                            <option value="3">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTipoPaciente" class="form-label">Tipo de Paciente</label>
                        <select id="editTipoPaciente" class="form-control" name="tipoPaciente_idtipoPaciente" required>
                            <option value="1">Nuevo Paciente</option>
                            <option value="2">Paciente Recurrente</option>
                            <option value="3">Paciente de Emergencia</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Envío del formulario con AJAX para actualizar los datos del paciente
    $('#editPacienteForm').on('submit', function(e) {
        e.preventDefault(); // Evita el envío normal del formulario

        const idPaciente = $('#editpacienteId').val();
        const nombre = $('#editNombre').val();
        const apellido = $('#editApellido').val();
        const telefono = $('#editTelefono').val();
        const email = $('#editEmail').val();
        const edad = $('#editEdad').val();
        const fechaNacimiento = $('#editFechaNacimiento').val();
        const direccion = $('#editDireccion').val();
        const nit = $('#editNit').val();
        const dpi = $('#editDpi').val();
        const tipoPaciente_idtipoPaciente = $('#editTipoPaciente').val();

        // Crear un objeto con todos los datos del paciente a actualizar
        const formData = {
            idPaciente: idPaciente,
            nombre: nombre,
            apellido: apellido,
            telefono: telefono,
            email: email,
            edad: edad,
            fechaNacimiento: fechaNacimiento,
            direccion: direccion,
            nit: nit,
            dpi: dpi,
            tipoPaciente_idtipoPaciente: tipoPaciente_idtipoPaciente
        };

        console.log("Datos a enviar: ", formData);

        $.ajax({
            type: 'PUT', // Cambiamos a PUT para actualizar
            url: '/admin/pacientes/' + idPaciente,
            data: JSON.stringify(formData),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(response) {
                alert('Paciente actualizado exitosamente.');
                $('#editpacienteModal').modal('hide');
                location.reload(); // Recargar la página para ver los cambios actualizados
            },
            error: function(err) {
                console.error('Error al actualizar paciente:', err);
                alert('Error al actualizar paciente. Por favor, inténtelo de nuevo.');
            }
        });
    });
</script>



<!-- Pie de página -->
 <footer class="bg-dark text-white text-center py-3">
    <p class="mb-0">&copy; 2024 SHINE DENTAL. Todos los derechos reservados.</p>
</footer>
<!-- /Pie de página -->

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/js/dashboard.js"></script>
    <script>
        $(document).ready(function() {
        var table = $('#pacienteTable').DataTable({
        destroy: true,
        paging: true,
        searching: true,  // Habilita la búsqueda
        ordering: true,
        info: true,
        lengthChange: false,
        language: {
            info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
            paginate: {
                next: 'Siguiente',
                previous: 'Anterior',
            },
            emptyTable: 'No hay pacientes disponibles'
        },
        order: []  // No establecer un orden por defecto al cargar la tabla
    });

    // Vincula el campo de búsqueda personalizado al DataTable
    $('#searchPaciente').on('keyup', function() {
        table.search(this.value).draw();
    });
});

        $('#addPacienteForm').on('submit', function(e) {
            e.preventDefault();  // Evitar el envío por defecto del formulario

            // Recoge los datos del formulario
            const formData = {
                nombre: $('#nombre').val(),
                apellido: $('#apellido').val(),
                telefono: $('#telefono').val(),
                email: $('#email').val(),
                edad: $('#edad').val(),
                fechaNacimiento: $('#fechaNacimiento').val(),
                direccion: $('#direccion').val(),
                nit: $('#nit').val(),
                dpi: $('#dpi').val(),
                genero_idGenero: $('#genero_idGenero').val(),
                tipoPaciente_idtipoPaciente: $('#tipoPaciente_idtipoPaciente').val(),
                nombreEmergencia: $('#nombreEmergencia').val(),
                numeroEmergencia: $('#numeroEmergencia').val(),
                parentescoEmergencia: $('#parentescoEmergencia').val()
            };

            // Enviar los datos al backend con AJAX
            $.ajax({
                type: 'POST',
                url: '/admin/pacientes',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function(response) {
                    alert('Paciente agregado exitosamente.');
                    $('#addpacienteModal').modal('hide');
                    location.reload();  // Recargar la página para ver los cambios
                },
                error: function(err) {
                    console.error('Error al agregar paciente:', err.responseJSON.message);
                    alert('Error al agregar paciente: ' + err.responseJSON.message);
                }
            });
        });

        // Función para agregar paciente
        function guardarpaciente() {
            const name = $('#addpacienteName').val();
            const specialty = $('#addpacienteSpecialty').val();

            $.ajax({
                type: 'POST',
                url: '/admin/pacientes',
                data: JSON.stringify({ nombre: name, especialidad: specialty }),
                contentType: 'application/json',
                success: function(response) {
                    alert('paciente agregado exitosamente.');
                    $('#addpacienteModal').modal('hide');
                    location.reload();
                },
                error: function(err) {
                    console.error('Error al agregar paciente:', err);
                }
            });
        }

        // Función para eliminar paciente
        function deletePaciente(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este paciente?')) {
                fetch(`/pacientes/${id}`, {
                    method: 'DELETE',
                }).then(() => {
                    window.location.reload();
                });
            }
        }

        function editarPaciente(idPaciente, nombre, apellido, telefono, email, edad, fechaNacimiento, direccion, nit, dpi, tipoPaciente_idtipoPaciente,  fichaMedica_idfichaMedica) {
    console.log("Editing patient: ", idPaciente, nombre, apellido, telefono, email, edad, fechaNacimiento, direccion, nit, dpi, tipoPaciente_idtipoPaciente, fichaMedica_idfichaMedica);

    // Assign values to modal fields
    $('#editpacienteId').val(idPaciente);
    $('#editNombre').val(nombre);
    $('#editApellido').val(apellido);
    $('#editTelefono').val(telefono);
    $('#editEmail').val(email);
    $('#editEdad').val(edad);
    $('#editFechaNacimiento').val(fechaNacimiento);
    $('#editDireccion').val(direccion);
    $('#editNit').val(nit);
    $('#editDpi').val(dpi);
    $('#editTipoPaciente').val(tipoPaciente_idtipoPaciente);
    
    $('#editFichaMedica').val(fichaMedica_idfichaMedica);

    // Show the modal
    $('#editpacienteModal').modal('show');
}

$(document).ready(function() {
    $('#editPacienteForm').on('submit', function(e) {
        e.preventDefault(); // Evita el envío normal del formulario

        // Recoge todos los valores del formulario de edición
        const idPaciente = $('#editpacienteId').val();
        const nombre = $('#editNombre').val();
        const apellido = $('#editApellido').val();
        const telefono = $('#editTelefono').val();
        const email = $('#editEmail').val();
        const edad = $('#editEdad').val();
        const fechaNacimiento = $('#editFechaNacimiento').val();
        const direccion = $('#editDireccion').val();
        const nit = $('#editNit').val();
        const dpi = $('#editDpi').val();
        const tipoPaciente_idtipoPaciente = $('#editTipoPaciente').val();
        const genero_idGenero = $('#editGenero').val();
        const fichaMedica_idfichaMedica = $('#editFichaMedica').val();

        // Datos a enviar
        const formData = {
            idPaciente: idPaciente,
            nombre: nombre,
            apellido: apellido,
            telefono: telefono,
            email: email,
            edad: edad,
            fechaNacimiento: fechaNacimiento,
            direccion: direccion,
            nit: nit,
            dpi: dpi,
            tipoPaciente_idtipoPaciente: tipoPaciente_idtipoPaciente,
            genero_idGenero: genero_idGenero,
            fichaMedica_idfichaMedica: fichaMedica_idfichaMedica
        };

        console.log("Datos a enviar: ", formData);

        // Enviar todos los datos mediante AJAX (sin usar JSON)
        $.ajax({
            type: 'PUT',
            url: `/admin/pacientes/${idPaciente}`,
            data: formData,  // Enviar los datos como un formulario
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Cambiando el tipo de contenido
            success: function(response) {
                alert('Paciente actualizado exitosamente.');
                $('#editpacienteModal').modal('hide');
                location.reload(); // Recarga la página para ver los cambios
            },
            error: function(err) {
                console.error('Error al actualizar paciente:', err);
                if (err.responseJSON && err.responseJSON.message) {
                    alert('Error al actualizar paciente: ' + err.responseJSON.message);
                } else {
                    alert('Error al actualizar paciente. Por favor intenta nuevamente.');
                }
            }
        });
    });
});

        function ajaxPost(url, data, successCallback) {
            $.ajax({
                type: 'POST',
                url: url,
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: successCallback,
                error: function(err) {
                    handleError(err);
                }
            });
        }
    
        function ajaxPut(url, data, successCallback) {
            $.ajax({
                type: 'PUT',
                url: url,
                data: data,
                success: successCallback,
                error: function(err) {
                    handleError(err);
                }
            });
        }
    
        function handleError(err) {
            console.error('Error:', err);
            alert('Ocurrió un error: ' + (err.responseJSON?.message || 'Error desconocido'));
        }

        function verInformacion(id, nombre, apellido, telefono, email, edad, tipoPaciente, genero, fechaNacimiento, direccion, nit, dpi, historialClinico, fichaMedica) {

            const formattedFechaNacimiento = new Date(fechaNacimiento).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            $('#infopacienteName').text(nombre);
            $('#infopacienteLastName').text(apellido);
            $('#infopacienteDpi').text(dpi);
            $('#infopacientePhone').text(telefono);
            $('#infopacienteEmail').text(email);
            $('#infopacienteEdad').text(edad);
            $('#infopacienteGenero').text(genero);
            $('#infopacienteFechaNacimiento').text(fechaNacimiento ? formattedFechaNacimiento: 'N/A');
            $('#infopacienteDireccion').text(direccion);
            $('#infopacienteNit').text(nit ? nit : 'N/A');
            $('#infopacienteTipoPaciente').text(tipoPaciente);
            $('#infopacienteHistorialClinico').text(historialClinico ? historialClinico : 'N/A');
            $('#infopacienteFichaMedica').text(fichaMedica ? fichaMedica : 'N/A');
    
            let tipoPacienteStr = {
                '1': 'Nuevo Paciente',
                '2': 'Paciente Recurrente',
                '3': 'Paciente de Emergencia'
            }[tipoPaciente] || 'Desconocido';
    
            $('#infopacienteTipoPaciente').text(tipoPacienteStr);
    
            $.ajax({
                type: 'GET',
                url: `/fichamedica/existe/${id}`,
                success: function(existe) {
                    document.getElementById(`btnAgregarFicha-${id}`).disabled = existe;
                },
                error: function(err) {
                    console.error('Error al verificar existencia de ficha médica:', err);
                }
            });

    
            $('#infopacienteModal').modal('show');
        }

function disableModalFeatures() {
    const modalElement = document.querySelector('.modal-class'); // Ajusta el selector según tu estructura

    if (modalElement) {
        modalElement.classList.add('disabled'); // Ajusta la acción que deseas realizar
    } else {
        console.error('El elemento modal no está presente en el DOM.');
    }
}


function archivarPaciente(id) {
    if (confirm('¿Estás seguro de que deseas archivar este paciente?')) {
        fetch(`/pacientes/archivar/${id}`, {
            method: 'PUT',
        }).then(response => {
            if (response.ok) {
                alert('Paciente archivado exitosamente.');
                location.reload(); // Recargar para reflejar cambios
            } else {
                alert('Error al archivar el paciente.');
            }
        });
    }
}

        function agregarFichaMedica(pacienteId) {
            $.ajax({
                type: 'POST',
                url: '/admin/fichamedica/agregar',
                data: {
                    pacienteId: pacienteId,
                },
                success: function() {
                    $(`#btnAgregarFicha-${pacienteId}`).prop('disabled', true);
                    alert('Ficha médica agregada exitosamente');
                },
                error: function(err) {
                    handleError(err);
                }
            });
        }
    </script>
</body>
</html>